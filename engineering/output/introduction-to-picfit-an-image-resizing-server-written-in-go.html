<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Ulule Engineering</title>
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
    <link href='https://fonts.googleapis.com/css?family=Oswald:400,700,300' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Lora:400,400italic,700,700italic' rel='stylesheet' type='text/css'>
    <link href="theme/css/style.css" rel="stylesheet" media="all">
    <link href="https://d1yggf0lcx0ykm.cloudfront.net/apple-touch-icon.63c1116b1112.png" rel="apple-touch-icon">
    <link href="https://d1yggf0lcx0ykm.cloudfront.net/apple-touch-icon-precomposed.37d746686d25.png" rel="apple-touch-icon-precomposed">
    <link href="https://d1yggf0lcx0ykm.cloudfront.net/apple-touch-icon-114x114.f7a7d4822c52.png" sizes="114x114" rel="apple-touch-icon">
    <link href="https://d1yggf0lcx0ykm.cloudfront.net/apple-touch-icon-114x114-precomposed.f7a7d4822c52.png" sizes="114x114" rel="apple-touch-icon-precomposed">
    <link href="https://d1yggf0lcx0ykm.cloudfront.net/site/partners/ulule/favicon.ico" type="image/gif" rel="icon">
    <!--[if IE]><link rel="shortcut icon" type="image/x-icon" href="https://d1yggf0lcx0ykm.cloudfront.net/site/partners/ulule/favicon.ico" /><![endif]-->
  </head>
  <body>
    <header class="header">
      <span class="header__logo">
        <a href="index.html">
          <img src="theme/img/ulule-eyes.png" alt="Ulule" height="22" width="42"><span>Engineering</span>
        </a>
      </span>
      <span class="header__back">
        <a href="http://ulule.com">
          <span>Back to Ulule</span><i class="icowl-enter"></i>
        </a>
      </span>
    </header>
    <main>
      <article class="single">
        <header class="single__header">
          <h1 class="single__title">Introduction to picfit, an image resizing server written in Go</h1>
          <ul class="single__infos">
            <li class="single__avatar">
                <img src="/theme/img/Florent Messa.jpg" alt="avatar" height="90" width="90">
            </li><li class="single__author">
              <span>Florent Messa</span>
            </li><li class="single__date">
              <date>13 April 2017</date>
            </li>
          </ul>
        </header>
        <div class="single__content">
          <div class="section" id="the-motivation">
<h2>The motivation</h2>
<p>The idea behind <a class="reference external" href="https://github.com/thoas/picfit">picfit</a> came from the need of exporting image processing
(resize, thumbnail, etc.) to an independent web service which will be
able to manage my files no matter the storage
engine used (s3, file system, etc.).</p>
<p>When you are dealing with resizing on demand, you have to store keys of
generated images to a data storage to avoid generating the same image twice.
With a unique interface, picfit allows you to use or
implement your favorite data storage.</p>
<p>At <a class="reference external" href="http://www.ulule.com">ulule.com</a>, <a class="reference external" href="https://github.com/thoas/picfit">picfit</a> allows us to remove
a large amount of code for avatars and project images processing and
avoid synchronous calls to retrieve generated images, which can have
an impact on your application performance.</p>
</div>
<div class="section" id="why-using-go-lang-over-insert-another-cool-language-here">
<h2>Why using Go lang over &lt;insert another cool language here&gt;?</h2>
<p>Go language has been chosen because it allows to generate a binary file
and make deployments easier, have better concurrency mechanism
(I'm looking at you GIL) with a simple language.</p>
<p>Another advantage for Go was the large number of developers
were excited about it.</p>
<p>There are plenty of great articles on why you should use Go
and why you should avoid it ☺</p>
</div>
<div class="section" id="installation">
<h2>Installation</h2>
<p>The best way to use <a class="reference external" href="https://github.com/thoas/picfit">picfit</a> locally for testing it, before any
installation on a real server, is to use <a class="reference external" href="https://www.vagrantup.com/">Vagrant</a> with a virtual machine.</p>
<ol class="arabic">
<li><p class="first">First, make sure you have installed <a class="reference external" href="https://www.vagrantup.com/">Vagrant</a> and <a class="reference external" href="https://www.virtualbox.org">VirtualBox</a></p>
</li>
<li><p class="first">Clone the <a class="reference external" href="https://github.com/thoas/picfit">picfit</a> repository</p>
<pre class="literal-block">
$ git clone https://github.com/thoas/picfit
</pre>
</li>
<li><p class="first">Install <a class="reference external" href="http://www.ansible.com/">Ansible</a> to use provisioning files from the picfit repository,
depending your OS, it can be done like so:</p>
</li>
</ol>
<pre class="literal-block">
$ pip install ansible
</pre>
<ol class="arabic simple" start="4">
<li>Start the virtual machine, Vagrant will run provisioning automatically,
it can be long so grab a coffee or a tea ☺</li>
</ol>
<pre class="literal-block">
$ vagrant up
</pre>
<p>On the virtual machine, <a class="reference external" href="https://github.com/thoas/picfit">picfit</a> runs on port <strong>8080</strong> behind Varnish
on port <strong>80</strong>.</p>
<p>In the <a class="reference external" href="https://github.com/thoas/picfit/blob/master/Vagrantfile#L23">Vagrantfile</a>, the port <strong>80</strong> is forwarded on the virtual machine
to the port <strong>8080</strong> on your machine, <a class="reference external" href="https://github.com/thoas/picfit">picfit</a> will be available using HTTP:</p>
<pre class="literal-block">
http://127.0.0.1:8080
</pre>
</div>
<div class="section" id="usage">
<h2>Usage</h2>
<p>To call the service you should provide the following parameters:</p>
<pre class="literal-block">
http://localhost:3001/{method}?url={url}&amp;path={path}&amp;w={width}&amp;h={height}&amp;upscale={upscale}&amp;sig={sig}&amp;op={operation}&amp;fmt={format}
</pre>
<ul class="simple">
<li>path — The filepath to load the image using your source
storage (optional, if you haven’t configured a source storage)</li>
<li>method — The operation to perform: <strong>display</strong>, <strong>redirect</strong> or <strong>get</strong></li>
<li>sig - The signature key which is the representation of your query string
and your secret key (optional, if you haven’t configured a secret key)</li>
<li>url — The url of the image which will be retrieved by HTTP (optional, if path is provided)</li>
<li>width — The desired width of the image,
if 0 is provided the service will calculate the ratio with <strong>height</strong></li>
<li>height — The desired height of the image,
if 0 is provided the service will calculate the ratio with <strong>width</strong></li>
<li>upscale — If your image is smaller than your desired dimensions,
the service will upscale it by default to fit your dimensions,
you can disable this behavior by providing 0 (optional)</li>
<li>format — The output format to save the image, by default the format
will be the source format, for example a GIF image
source will be saved as GIF (optional)</li>
</ul>
</div>
<div class="section" id="basic-examples">
<h2>Basic examples</h2>
<p>Let’s take as a basic experiment, a logo that everyone knows well.</p>
<img alt="" src="https://cdn-images-1.medium.com/max/1600/1*V-OWuu3-GgNFkDOQgrmrzg.png" />
<pre class="literal-block">
http://www.google.fr/images/srpr/logo11w.png (538x190)
</pre>
<ol class="arabic simple">
<li>Resize the image to <strong>200 width</strong> and calculate the <strong>height</strong> ratio</li>
</ol>
<img alt="" src="https://cdn-images-1.medium.com/max/1600/1*9RKGTfQCXyWB6RVyjc1zlg.png" />
<pre class="literal-block">
http://localhost:8080/display?url=http://www.google.fr/images/srpr/logo11w.png&amp;w=200&amp;h=0&amp;op=resize
</pre>
<ol class="arabic simple" start="2">
<li>Resize the image to <strong>200 width</strong> and <strong>100 height</strong></li>
</ol>
<img alt="" src="https://cdn-images-1.medium.com/max/1600/1*ufchoQbRFdg4tczAS6lGRA.png" />
<pre class="literal-block">
http://localhost:8080/display?url=http://www.google.fr/images/srpr/logo11w.png&amp;w=200&amp;h=100&amp;op=resize
</pre>
<ol class="arabic simple" start="3">
<li>Thumbnail the image to <strong>300 width</strong> and <strong>50 height</strong>, it will perform a crop operation from the center of it</li>
</ol>
<img alt="" src="https://cdn-images-1.medium.com/max/1600/1*pIvIQj0nd90qCjKnd87gVg.png" />
<pre class="literal-block">
http://localhost:8080/display?url=http://www.google.fr/images/srpr/logo11w.png&amp;w=300&amp;h=50&amp;op=thumbnail
</pre>
<ol class="arabic simple" start="4">
<li>Resize the image to <strong>600 width</strong> and calculate the ratio to find the perfect height, the image will be degraded</li>
</ol>
<img alt="" src="https://cdn-images-1.medium.com/max/1600/1*B_smig-gRy4HZ-fmJETLkg.png" />
<pre class="literal-block">
http://localhost:8080/display?url=http://www.google.fr/images/srpr/logo11w.png&amp;w=600&amp;h=0&amp;op=resize
</pre>
<p>If you want <a class="reference external" href="https://github.com/thoas/picfit">picfit</a> to not upscale the image to the specific size
(in case when your size is higher than the original image size),
you can disable the upscale behavior.</p>
<img alt="" src="https://cdn-images-1.medium.com/max/1600/1*phQamw5IO1eV7345KIw1Sg.png" />
<pre class="literal-block">
http://localhost:8080/display?url=http://www.google.fr/images/srpr/logo11w.png&amp;w=600&amp;h=0&amp;op=resize&amp;upscale=0
</pre>
</div>
<div class="section" id="configuring-a-source-storage">
<h2>Configuring a source storage</h2>
<p>Now we know picfit can retrieve an image from any URL using HTTP, we will
configure an Amazon S3 storage to retrieve our uploaded images and
store generated images to a different Amazon S3 storage.</p>
<p>We will call our source Amazon S3 bucket <strong>source-bucket</strong> located a datacenter
in europe and our destination Amazon S3 bucket <strong>dest-bucket</strong>
located to another datacenter in USA.</p>
<p>Provisioning files from the picfit repository comes with an installation
of Redis as a key/value store on the 6380 port.</p>
<p>The key/value store will be needed when you want to avoid to generate
a resized image twice. For each request picfit will generate an unique key
to identify the operation made and store the result on the key/value store.</p>
<ol class="arabic simple">
<li>Edit the <strong>config.json</strong> of picfit located to <strong>/etc/picfit</strong></li>
</ol>
<div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;kvstore&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;redis&quot;</span><span class="p">,</span>
    <span class="nt">&quot;host&quot;</span><span class="p">:</span> <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span>
    <span class="nt">&quot;port&quot;</span><span class="p">:</span> <span class="s2">&quot;6380&quot;</span><span class="p">,</span>
    <span class="nt">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nt">&quot;prefix&quot;</span><span class="p">:</span> <span class="s2">&quot;picfit:&quot;</span><span class="p">,</span>
    <span class="nt">&quot;db&quot;</span><span class="p">:</span> <span class="mi">0</span>
  <span class="p">},</span>
  <span class="nt">&quot;port&quot;</span><span class="p">:</span> <span class="mi">8080</span><span class="p">,</span>
  <span class="nt">&quot;storage&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;src&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;s3&quot;</span><span class="p">,</span>
      <span class="nt">&quot;access_key_id&quot;</span><span class="p">:</span> <span class="s2">&quot;[ACCESS_KEY_ID]&quot;</span><span class="p">,</span>
      <span class="nt">&quot;secret_access_key&quot;</span><span class="p">:</span> <span class="s2">&quot;[SECRET_ACCESS_KEY]&quot;</span><span class="p">,</span>
      <span class="nt">&quot;bucket_name&quot;</span><span class="p">:</span> <span class="s2">&quot;source-bucket&quot;</span><span class="p">,</span>
      <span class="nt">&quot;acl&quot;</span><span class="p">:</span> <span class="s2">&quot;public-read&quot;</span><span class="p">,</span>
      <span class="nt">&quot;region&quot;</span><span class="p">:</span> <span class="s2">&quot;eu-west-1&quot;</span><span class="p">,</span>
      <span class="nt">&quot;location&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;dst&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;s3&quot;</span><span class="p">,</span>
      <span class="nt">&quot;access_key_id&quot;</span><span class="p">:</span> <span class="s2">&quot;[ACCESS_KEY_ID]&quot;</span><span class="p">,</span>
      <span class="nt">&quot;secret_access_key&quot;</span><span class="p">:</span> <span class="s2">&quot;[SECRET_ACCESS_KEY]&quot;</span><span class="p">,</span>
      <span class="nt">&quot;bucket_name&quot;</span><span class="p">:</span> <span class="s2">&quot;dest-bucket&quot;</span><span class="p">,</span>
      <span class="nt">&quot;acl&quot;</span><span class="p">:</span> <span class="s2">&quot;public-read-write&quot;</span><span class="p">,</span>
      <span class="nt">&quot;region&quot;</span><span class="p">:</span> <span class="s2">&quot;us-west-1&quot;</span><span class="p">,</span>
      <span class="nt">&quot;location&quot;</span><span class="p">:</span> <span class="s2">&quot;cache&quot;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>Generated images will be stored on the destination storage in the <strong>cache</strong> location.
Our source storage (which is an Amazon S3 bucket) contains our logo
stored at the location <strong>images/srpr/logo11w.png</strong>.</p>
<p>By default, if you don’t specify a destination storage, <a class="reference external" href="https://github.com/thoas/picfit">picfit</a>
will store generated images to the source storage.</p>
<ol class="arabic simple" start="2">
<li>Restart the picfit service</li>
</ol>
<pre class="literal-block">
$ sudo service picfit restart
</pre>
<p>picfit implements the <a class="reference external" href="https://github.com/facebookgo/grace">facebook/grace</a> which
allows you to restart it gracefully</p>
<pre class="literal-block">
$ sudo kill -USR2 $(cat /var/run/picfit.pid)
</pre>
<p>We are ready! Let’s convert our previous examples using the source storage.</p>
<ol class="arabic simple">
<li>Resize the image to <strong>200 width</strong> and calculate the <strong>height</strong> ratio</li>
</ol>
<img alt="" src="https://cdn-images-1.medium.com/max/1600/1*9RKGTfQCXyWB6RVyjc1zlg.png" />
<pre class="literal-block">
http://localhost:8080/display/resize/200x/images/srpr/logo11w.png
</pre>
<ol class="arabic simple" start="2">
<li>Resize the image to <strong>200 width</strong> and <strong>100 height</strong></li>
</ol>
<img alt="" src="https://cdn-images-1.medium.com/max/1600/1*ufchoQbRFdg4tczAS6lGRA.png" />
<pre class="literal-block">
http://localhost:8080/display/resize/200x100/images/srpr/logo11w.png
</pre>
<ol class="arabic simple" start="3">
<li>Thumbnail the image to <strong>300 width</strong> and <strong>50 height</strong></li>
</ol>
<img alt="" src="https://cdn-images-1.medium.com/max/1600/1*pIvIQj0nd90qCjKnd87gVg.png" />
<pre class="literal-block">
http://localhost:8080/display/thumbnail/300x50/images/srpr/logo11w.png
</pre>
<ol class="arabic simple" start="4">
<li>Resize the image to <strong>600 width</strong> and disable upscale</li>
</ol>
<img alt="" src="https://cdn-images-1.medium.com/max/1600/1*phQamw5IO1eV7345KIw1Sg.png" />
<pre class="literal-block">
http://localhost:8080/display/resize/600x/images/srpr/logo11w.png?upscale=0
</pre>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>It has been a long introduction, if you have reach to the bottom
you belong to the brave ☺.</p>
<p>There are multiple others features (<a class="reference external" href="https://github.com/thoas/picfit#security">Security</a>, <a class="reference external" href="https://github.com/thoas/picfit#error-reporting">Sentry integration</a>, <a class="reference external" href="https://github.com/thoas/picfit#methods">others methods</a>, etc.)
which are not described in this blog post, if you are curious enough
go check the <a class="reference external" href="https://github.com/thoas/picfit/blob/master/README.rst">README</a> of the project.</p>
</div>
<div class="section" id="contributing-to-picfit">
<h2>Contributing to picfit</h2>
<ul class="simple">
<li>Ping me on twitter <a class="reference external" href="http://twitter.com/thoas">&#64;thoas</a></li>
<li>Fork the <a class="reference external" href="https://github.com/thoas/picfit">project</a></li>
<li>Fix <a class="reference external" href="https://github.com/thoas/picfit/issues">bugs</a></li>
<li>Add more unit tests</li>
</ul>
<p>Don’t hesitate ☺!</p>
</div>

    <footer class="footer">
      <ul class="footer__list">
        <li class="footer__item">
          <a class="footer__link footer__link--github" href="https://github.com/ulule">
            <span class="fa-stack fa-lg">
              <i class="fa fa-github fa-stack-2x"></i>
            </span>
          </a>
        </li><li class="footer__item">
          <a class="footer__link footer__link--facebook" href="https://facebook.com/ulule">
            <span class="fa-stack fa-lg">
              <i class="fa fa-circle fa-stack-2x"></i>
              <i class="fa fa-facebook fa-stack-1x"></i>
            </span>
          </a>
        </li><li class="footer__item">
          <a class="footer__link footer__link--twitter" href="https://twitter.com/ulule">
            <span class="fa-stack fa-lg">
              <i class="fa fa-circle fa-stack-2x"></i>
              <i class="fa fa-twitter fa-stack-1x"></i>
            </span>
          </a>
        </li>
      </ul>
    </footer>
  </body>
</html>