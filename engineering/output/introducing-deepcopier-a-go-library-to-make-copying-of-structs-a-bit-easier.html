<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Ulule Engineering</title>
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
    <link href='https://fonts.googleapis.com/css?family=Oswald:400,700,300' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Lora:400,400italic,700,700italic' rel='stylesheet' type='text/css'>
    <link href="theme/css/style.css" rel="stylesheet" media="all">
    <link href="https://d1yggf0lcx0ykm.cloudfront.net/apple-touch-icon.63c1116b1112.png" rel="apple-touch-icon">
    <link href="https://d1yggf0lcx0ykm.cloudfront.net/apple-touch-icon-precomposed.37d746686d25.png" rel="apple-touch-icon-precomposed">
    <link href="https://d1yggf0lcx0ykm.cloudfront.net/apple-touch-icon-114x114.f7a7d4822c52.png" sizes="114x114" rel="apple-touch-icon">
    <link href="https://d1yggf0lcx0ykm.cloudfront.net/apple-touch-icon-114x114-precomposed.f7a7d4822c52.png" sizes="114x114" rel="apple-touch-icon-precomposed">
    <link href="https://d1yggf0lcx0ykm.cloudfront.net/site/partners/ulule/favicon.ico" type="image/gif" rel="icon">
    <!--[if IE]><link rel="shortcut icon" type="image/x-icon" href="https://d1yggf0lcx0ykm.cloudfront.net/site/partners/ulule/favicon.ico" /><![endif]-->
  </head>
  <body>
    <header class="header">
      <span class="header__logo">
        <a href="index.html">
          <img src="theme/img/ulule-eyes.png" alt="Ulule" height="22" width="42"><span>Engineering</span>
        </a>
      </span>
      <span class="header__back">
        <a href="http://ulule.com">
          <span>Back to Ulule</span><i class="icowl-enter"></i>
        </a>
      </span>
    </header>
    <main>
      <article class="single">
        <header class="single__header">
          <h1 class="single__title">Introducing deepcopier, a Go library to make copying of structs a bit easier</h1>
          <ul class="single__infos">
            <li class="single__avatar">
                <img src="/theme/img/Florent Messa.jpg" alt="avatar" height="90" width="90">
            </li><li class="single__author">
              <span>Florent Messa</span>
            </li><li class="single__date">
              <date>13 April 2017</date>
            </li>
          </ul>
        </header>
        <div class="single__content">
          <div class="section" id="context">
<h2>Context</h2>
<p>We are currently refactoring our <a class="reference external" href="http://developers.ulule.com/">API</a> at Ulule from our monolithic Python
stack with <a class="reference external" href="https://github.com/django-tastypie/django-tastypie">django-tastypie</a> to a separate Go <a class="reference external" href="http://martinfowler.com/articles/microservices.html">microservice</a>.</p>
<p>When working with models in Go, you don't want to expose all columns and
also implement more methods without writing a lot of code, because everyone
knows programmers are lazy ;)</p>
<p><a class="reference external" href="https://github.com/ulule/deepcopier">deepcopier</a> will help you in your daily job when you want to copy a struct into
another one (think resource) or from another one (think payload).</p>
</div>
<div class="section" id="installation">
<h2>Installation</h2>
<p>Assuming you are already a Go developer, you have your environment up and ready,
so run this command in your shell:</p>
<pre class="literal-block">
$ go get github.com/ulule/deepcopier
</pre>
<p>You are now ready to use this library.</p>
</div>
<div class="section" id="usage">
<h2>Usage</h2>
<p>To demonstrate why you should use this library, we will build a dead simple REST
API in READ only.</p>
<p>We will use <a class="reference external" href="http://www.postgresql.org/">postgresql</a> as database so I'm also assuming you
already have <a class="reference external" href="http://www.postgresql.org/">postgresql</a> installed on your laptop :)</p>
<p>Let's create the databass!</p>
<pre class="literal-block">
$ psql postgres
psql (9.4.1)
Type &quot;help&quot; for help.

postgres=# create user dummy with password '';
CREATE ROLE
postgres=# create database dummy with owner dummy;
CREATE DATABASE
postgres=# \d
No relations found.
</pre>
<p>We now have a perfectly capable database with no tables, let's jump to the
SQL schema.</p>
<div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">account</span> <span class="p">(</span>
    <span class="n">id</span> <span class="nb">serial</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
    <span class="n">first_name</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span>
    <span class="n">last_name</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span>
    <span class="n">username</span> <span class="nb">VARCHAR</span> <span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="k">UNIQUE</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">password</span> <span class="nb">VARCHAR</span> <span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">email</span> <span class="nb">VARCHAR</span> <span class="p">(</span><span class="mi">355</span><span class="p">)</span> <span class="k">UNIQUE</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">date_joined</span> <span class="k">TIMESTAMP</span> <span class="k">NOT</span> <span class="k">NULL</span>
<span class="p">);</span>
</pre></div>
<p>Transfer this schema to <a class="reference external" href="http://www.postgresql.org/">postgresql</a>.</p>
<pre class="literal-block">
$ psql -U dummy
psql (9.4.1)
Type &quot;help&quot; for help.
dummy=#     CREATE TABLE account(
dummy(#         id serial PRIMARY KEY,
dummy(#         first_name VARCHAR (50),
dummy(#         last_name VARCHAR (50),
dummy(#         username VARCHAR (50) UNIQUE NOT NULL,
dummy(#         password VARCHAR (50) NOT NULL,
dummy(#         email VARCHAR (355) UNIQUE NOT NULL,
dummy(#         date_joined TIMESTAMP NOT NULL
dummy(#     );
CREATE TABLE
dummy=# \d
             List of relations
 Schema |      Name      |   Type   | Owner
--------+----------------+----------+-------
 public | account        | table    | thoas
 public | account_id_seq | sequence | thoas
(2 rows)

dummy=#
</pre>
<p>First insertions incoming!</p>
<pre class="literal-block">
dummy=# INSERT INTO account (username, first_name, last_name, password, email, date_joined) VALUES ('thoas', 'Florent', 'Messa', '8d56e93bcc8d63a171b5630282264341', 'foo&#64;bar.com', '2015-07-31 15:10:10');
</pre>
<p>At this point, we have a schema in a great database, we need to setup our
REST API.</p>
<p>We will use:</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/ant0ine/go-json-rest">go-json-rest</a> to handle requests</li>
<li><a class="reference external" href="https://github.com/jinzhu/gorm">gorm</a> to manipulate the database as an ORM</li>
</ul>
<p>In your shell, run this to install them</p>
<pre class="literal-block">
$ go get -u github.com/jinzhu/gorm
$ go get github.com/ant0ine/go-json-rest/rest
</pre>
<p>We will define a first attempt of our API to retrieve user information based
on its username.</p>
<p>We will rewrite our API three times so you need to focus.</p>
<div class="highlight"><pre><span></span><span class="c1">// main.go</span>
<span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;fmt&quot;</span>
    <span class="s">&quot;github.com/ant0ine/go-json-rest/rest&quot;</span>
    <span class="s">&quot;github.com/jinzhu/gorm&quot;</span>
    <span class="nx">_</span> <span class="s">&quot;github.com/lib/pq&quot;</span>
    <span class="s">&quot;log&quot;</span>
    <span class="s">&quot;net/http&quot;</span>
    <span class="s">&quot;os&quot;</span>
    <span class="s">&quot;time&quot;</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">Account</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">ID</span>         <span class="kt">uint</span> <span class="s">`gorm:&quot;primary_key&quot;`</span>
    <span class="nx">FirstName</span>  <span class="kt">string</span>
    <span class="nx">LastName</span>   <span class="kt">string</span>
    <span class="nx">Username</span>   <span class="kt">string</span>
    <span class="nx">Password</span>   <span class="kt">string</span>
    <span class="nx">Email</span>      <span class="kt">string</span>
    <span class="nx">DateJoined</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">Accounts</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Db</span> <span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">Accounts</span><span class="p">)</span> <span class="nx">Detail</span><span class="p">(</span><span class="nx">w</span> <span class="nx">rest</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">rest</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">account</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Account</span><span class="p">{}</span>
    <span class="nx">result</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">Db</span><span class="p">.</span><span class="nx">First</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">account</span><span class="p">,</span> <span class="s">&quot;username = ?&quot;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">PathParam</span><span class="p">(</span><span class="s">&quot;username&quot;</span><span class="p">))</span>

    <span class="k">if</span> <span class="nx">result</span><span class="p">.</span><span class="nx">RecordNotFound</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">rest</span><span class="p">.</span><span class="nx">NotFound</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="nx">w</span><span class="p">.</span><span class="nx">WriteJson</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">account</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">dsn</span> <span class="o">:=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;user=%s dbname=%s sslmode=disable&quot;</span><span class="p">,</span>
        <span class="nx">os</span><span class="p">.</span><span class="nx">Getenv</span><span class="p">(</span><span class="s">&quot;DATABASE_USER&quot;</span><span class="p">),</span>
        <span class="nx">os</span><span class="p">.</span><span class="nx">Getenv</span><span class="p">(</span><span class="s">&quot;DATABASE_NAME&quot;</span><span class="p">))</span>

    <span class="nx">db</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">gorm</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="s">&quot;postgres&quot;</span><span class="p">,</span> <span class="nx">dsn</span><span class="p">)</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">dsn</span><span class="p">)</span>

    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">db</span><span class="p">.</span><span class="nx">DB</span><span class="p">()</span>
    <span class="nx">db</span><span class="p">.</span><span class="nx">DB</span><span class="p">().</span><span class="nx">Ping</span><span class="p">()</span>
    <span class="nx">db</span><span class="p">.</span><span class="nx">DB</span><span class="p">().</span><span class="nx">SetMaxIdleConns</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="nx">db</span><span class="p">.</span><span class="nx">DB</span><span class="p">().</span><span class="nx">SetMaxOpenConns</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="nx">db</span><span class="p">.</span><span class="nx">SingularTable</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
    <span class="nx">db</span><span class="p">.</span><span class="nx">LogMode</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>

    <span class="nx">api</span> <span class="o">:=</span> <span class="nx">rest</span><span class="p">.</span><span class="nx">NewApi</span><span class="p">()</span>

    <span class="nx">api</span><span class="p">.</span><span class="nx">Use</span><span class="p">(</span><span class="nx">rest</span><span class="p">.</span><span class="nx">DefaultDevStack</span><span class="o">...</span><span class="p">)</span>

    <span class="nx">accounts</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Accounts</span><span class="p">{</span><span class="nx">Db</span><span class="p">:</span> <span class="nx">db</span><span class="p">}</span>

    <span class="nx">router</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rest</span><span class="p">.</span><span class="nx">MakeRouter</span><span class="p">(</span>
        <span class="nx">rest</span><span class="p">.</span><span class="nx">Get</span><span class="p">(</span><span class="s">&quot;/users/:username&quot;</span><span class="p">,</span> <span class="nx">accounts</span><span class="p">.</span><span class="nx">Detail</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">api</span><span class="p">.</span><span class="nx">SetApp</span><span class="p">(</span><span class="nx">router</span><span class="p">)</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">ListenAndServe</span><span class="p">(</span><span class="s">&quot;:8080&quot;</span><span class="p">,</span> <span class="nx">api</span><span class="p">.</span><span class="nx">MakeHandler</span><span class="p">()))</span>
<span class="p">}</span>
</pre></div>
<p>Let's start the server then</p>
<pre class="literal-block">
$ DATABASE_USER=dummy DATABASE_NAME=dummy go run main.go
</pre>
<p>and retrieve the response.</p>
<pre class="literal-block">
$ curl http://localhost:8080/users/thoas
{
  &quot;ID&quot;: 1,
  &quot;Username&quot;: &quot;thoas&quot;,
  &quot;FirstName&quot;: &quot;Florent&quot;,
  &quot;LastName&quot;: &quot;Messa&quot;,
  &quot;Password&quot;: &quot;8d56e93bcc8d63a171b5630282264341&quot;,
  &quot;Email&quot;: &quot;foo&#64;bar.com&quot;,
  &quot;DateJoined&quot;: &quot;2015-07-31T15:10:10Z&quot;
}
</pre>
<p>Wait a minute? You are exposing the user's password... this not
what we are excepting... We want this specific format</p>
<div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nt">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;thoas&quot;</span><span class="p">,</span>
  <span class="nt">&quot;first_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Florent&quot;</span><span class="p">,</span>
  <span class="nt">&quot;last_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Messa&quot;</span><span class="p">,</span>
  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Florent Messa&quot;</span><span class="p">,</span>
  <span class="nt">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;foo@bar.com&quot;</span><span class="p">,</span>
  <span class="nt">&quot;date_joined&quot;</span><span class="p">:</span> <span class="s2">&quot;2015-07-31T15:10:10Z&quot;</span><span class="p">,</span>
  <span class="nt">&quot;api_url&quot;</span><span class="p">:</span> <span class="s2">&quot;http://localhost:8080/users/thoas&quot;</span>
<span class="p">}</span>
</pre></div>
<p>Implement a separate struct named <tt class="docutils literal">AccountResource</tt></p>
<div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">AccountResource</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">ID</span>         <span class="kt">uint</span>      <span class="s">`json:&quot;id&quot;`</span>
    <span class="nx">Username</span>   <span class="kt">string</span>    <span class="s">`json:&quot;username&quot;`</span>
    <span class="nx">FirstName</span>  <span class="kt">string</span>    <span class="s">`json:&quot;first_name&quot;`</span>
    <span class="nx">LastName</span>   <span class="kt">string</span>    <span class="s">`json:&quot;last_name&quot;`</span>
    <span class="nx">Name</span>       <span class="kt">string</span>    <span class="s">`json:&quot;name&quot;`</span>
    <span class="nx">Email</span>      <span class="kt">string</span>    <span class="s">`json:&quot;email&quot;`</span>
    <span class="nx">DateJoined</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span> <span class="s">`json:&quot;date_joined&quot;`</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="nx">Account</span><span class="p">)</span> <span class="nx">Name</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;%s %s&quot;</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">FirstName</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">LastName</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
<p>and rewrite <tt class="docutils literal">Accounts.Detail</tt> to use <a class="reference external" href="https://github.com/ulule/deepcopier">deepcopier</a></p>
<div class="highlight"><pre><span></span><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">Accounts</span><span class="p">)</span> <span class="nx">Detail</span><span class="p">(</span><span class="nx">w</span> <span class="nx">rest</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">rest</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">account</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Account</span><span class="p">{}</span>
    <span class="nx">result</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">Db</span><span class="p">.</span><span class="nx">First</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">account</span><span class="p">,</span> <span class="s">&quot;username = ?&quot;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">PathParam</span><span class="p">(</span><span class="s">&quot;username&quot;</span><span class="p">))</span>

    <span class="k">if</span> <span class="nx">result</span><span class="p">.</span><span class="nx">RecordNotFound</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">rest</span><span class="p">.</span><span class="nx">NotFound</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="nx">resource</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">AccountResource</span><span class="p">{}</span>

    <span class="nx">deepcopier</span><span class="p">.</span><span class="nx">Copy</span><span class="p">(</span><span class="nx">account</span><span class="p">).</span><span class="nx">To</span><span class="p">(</span><span class="nx">resource</span><span class="p">)</span>

    <span class="nx">w</span><span class="p">.</span><span class="nx">WriteJson</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">resource</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
<p>We are good now, we can inspect our result</p>
<pre class="literal-block">
$ curl http://localhost:8080/users/thoas
{
  &quot;id&quot;: 1,
  &quot;username&quot;: &quot;thoas&quot;,
  &quot;first_name&quot;: &quot;Florent&quot;,
  &quot;last_name&quot;: &quot;Messa&quot;,
  &quot;name&quot;: &quot;Florent Messa&quot;,
  &quot;email&quot;: &quot;foo&#64;bar.com&quot;,
  &quot;date_joined&quot;: &quot;2015-07-31T15:10:10Z&quot;
}
</pre>
<p>Easy, right?</p>
<p>We will now rewrite for the last time <tt class="docutils literal">Accounts.Detail</tt> to provide
some context to retrieve the base url in <tt class="docutils literal">api_url</tt> attribute.</p>
<div class="highlight"><pre><span></span><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">Accounts</span><span class="p">)</span> <span class="nx">Detail</span><span class="p">(</span><span class="nx">w</span> <span class="nx">rest</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">rest</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">account</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Account</span><span class="p">{}</span>
    <span class="nx">result</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">Db</span><span class="p">.</span><span class="nx">First</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">account</span><span class="p">,</span> <span class="s">&quot;username = ?&quot;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">PathParam</span><span class="p">(</span><span class="s">&quot;username&quot;</span><span class="p">))</span>

    <span class="k">if</span> <span class="nx">result</span><span class="p">.</span><span class="nx">RecordNotFound</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">rest</span><span class="p">.</span><span class="nx">NotFound</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="nx">resource</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">AccountResource</span><span class="p">{}</span>

    <span class="nx">context</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}{</span><span class="s">&quot;base_url&quot;</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">BaseUrl</span><span class="p">()}</span>

    <span class="nx">deepcopier</span><span class="p">.</span><span class="nx">Copy</span><span class="p">(</span><span class="nx">account</span><span class="p">).</span><span class="nx">WithContext</span><span class="p">(</span><span class="nx">context</span><span class="p">).</span><span class="nx">To</span><span class="p">(</span><span class="nx">resource</span><span class="p">)</span>

    <span class="nx">w</span><span class="p">.</span><span class="nx">WriteJson</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">resource</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
<p>We need to update <tt class="docutils literal">AccountResource</tt> to implement the <tt class="docutils literal">ApiUrl</tt> new method</p>
<div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">AccountResource</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">ID</span>         <span class="kt">uint</span>      <span class="s">`json:&quot;id&quot;`</span>
    <span class="nx">Username</span>   <span class="kt">string</span>    <span class="s">`json:&quot;username&quot;`</span>
    <span class="nx">FirstName</span>  <span class="kt">string</span>    <span class="s">`json:&quot;first_name&quot;`</span>
    <span class="nx">LastName</span>   <span class="kt">string</span>    <span class="s">`json:&quot;last_name&quot;`</span>
    <span class="nx">Name</span>       <span class="kt">string</span>    <span class="s">`json:&quot;name&quot;`</span>
    <span class="nx">Email</span>      <span class="kt">string</span>    <span class="s">`json:&quot;email&quot;`</span>
    <span class="nx">DateJoined</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span> <span class="s">`json:&quot;date_joined&quot;`</span>
    <span class="nx">ApiUrl</span>     <span class="kt">string</span>    <span class="s">`deepcopier:&quot;context&quot; json:&quot;api_url&quot;`</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="nx">Account</span><span class="p">)</span> <span class="nx">Name</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;%s %s&quot;</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">FirstName</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">LastName</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="nx">Account</span><span class="p">)</span> <span class="nx">ApiUrl</span><span class="p">(</span><span class="nx">context</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{})</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;%s/users/%s&quot;</span><span class="p">,</span> <span class="nx">context</span><span class="p">[</span><span class="s">&quot;base_url&quot;</span><span class="p">],</span> <span class="nx">a</span><span class="p">.</span><span class="nx">Username</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
<p>We have now the final result of what we excepted for the first time :)</p>
<pre class="literal-block">
$ curl http://localhost:8080/users/thoas
{
  &quot;id&quot;: 1,
  &quot;username&quot;: &quot;thoas&quot;,
  &quot;first_name&quot;: &quot;Florent&quot;,
  &quot;last_name&quot;: &quot;Messa&quot;,
  &quot;name&quot;: &quot;Florent Messa&quot;,
  &quot;email&quot;: &quot;foo&#64;bar.com&quot;,
  &quot;date_joined&quot;: &quot;2015-07-31T15:10:10Z&quot;,
  &quot;api_url&quot;: &quot;http://localhost:8080/users/thoas&quot;
}
</pre>
<p>If you have reached to the bottom you belong to the brave!</p>
<p>It has been a long introduction, hope your enjoy it!</p>
</div>
<div class="section" id="contributing-to-deepcopier">
<h2>Contributing to deepcopier</h2>
<ul class="simple">
<li>Ping us on twitter <a class="reference external" href="https://twitter.com/oibafsellig">&#64;oibafsellig</a>, <a class="reference external" href="https://twitter.com/thoas">&#64;thoas</a></li>
<li>Fork the <a class="reference external" href="https://github.com/ulule/deepcopier">project</a></li>
<li>Fix <a class="reference external" href="https://github.com/ulule/deepcopier/issues">bugs</a></li>
</ul>
<p>Don't hesitate ;)</p>
</div>

    <footer class="footer">
      <ul class="footer__list">
        <li class="footer__item">
          <a class="footer__link footer__link--github" href="https://github.com/ulule">
            <span class="fa-stack fa-lg">
              <i class="fa fa-github fa-stack-2x"></i>
            </span>
          </a>
        </li><li class="footer__item">
          <a class="footer__link footer__link--facebook" href="https://facebook.com/ulule">
            <span class="fa-stack fa-lg">
              <i class="fa fa-circle fa-stack-2x"></i>
              <i class="fa fa-facebook fa-stack-1x"></i>
            </span>
          </a>
        </li><li class="footer__item">
          <a class="footer__link footer__link--twitter" href="https://twitter.com/ulule">
            <span class="fa-stack fa-lg">
              <i class="fa fa-circle fa-stack-2x"></i>
              <i class="fa fa-twitter fa-stack-1x"></i>
            </span>
          </a>
        </li>
      </ul>
    </footer>
  </body>
</html>